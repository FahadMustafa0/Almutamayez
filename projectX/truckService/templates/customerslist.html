{% extends 'base.html'%}
{% load crispy_forms_tags %}
{% block title%}
Customer Page
{% endblock title%}
{% block content%}

<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <div class="content-header" style="padding : 20px">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Manage Customer</h1>
        </div><!-- /.col -->
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active">Manage Customer</li>
          </ol>
        </div><!-- /.col -->
      </div><!-- /.row -->
    </div><!-- /.container-fluid -->
  </div>
  <!-- /.content-header -->

<!--Update_MOdal-->
<div class="modal fade" id="modal-default">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Update Customer Record</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <form action="" value="" id="updateForm" method="POST" class="ui form" enctype='multipart/form-data' >

                {% csrf_token %}
                <label for="first_name">First Name:</label>
                <input type='text' id="first_name" name="first_name">
                <label for="id_last_name">Last Name:</label>
                <input type='text' id="last_name" name="last_name" value="">
                <label for="id_location">Location:</label>
                <input type='text' id="location" name="location" value="">
                <label for="record_number">Record Number:</label>
                <input type='text' id="record_number" name="record_number" value="">
                <label for="building_number">Building Number:</label>
                <input type='text' id="building_number" name="building_number" value="">
                <label for="managing_by">Managing By:</label>
                <div class="input-group mb-3">
                    <select name="managing_by" class="custom-select" id="dropdown">

                     <!-- select data-->
                    </select>
                  </div>
                {% comment %} <input type='text' id="location" name="location" value=""> {% endcomment %}
                <label for="estate_name">Estatae Name:</label>
                <input type='text' id="estate_name" name="estate_name" value="">
                <label for="contact_person">Contact Person:</label>
                <input type='text' id="contact_person" name="contact_person" value="">
                <label for="email">:</label>
                <input type='text' id="email" name="email" value="">
                <label for="id_contact">Contact:</label>
                <input type='text' id="contact" name="contact" value="">
                <label for="id_tripCharges">Trip Charges:</label>
                <input type='text' id="tripCharges" name="tripCharges" value="">
                <label for="id_Vat">VAT%:</label>
                <input type='text' id="Vat" name="Vat" value="">
                <input type="hidden" id="postId" name="postId" value="" disabled>

                {% comment %} {{form1.as_table}}
                {{ cform.as_table }} {% endcomment %}



        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type='submit' id="update"  class="ui teal button">Update{% comment %} <i class="checkmark icon"></i> {% endcomment %}</button>
        </div>
    </form>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!--/modal-->
    <!-- Main content -->
    <section class="content">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Customers Records</h3>
          </div>
          <!-- /.card-header -->
          <div id="msgdiv"> </div>


          <div class="card-body">
            <table id="customerTable" class="table table-bordered table-hover">
                <thead>
                <tr>
                  <th>Customer Name</th>
                  <th>Location</th>
                  <th>Record Number</th>
                  <th>Building Number</th>
                  <th>Managing By</th>
                  <th>Estate Name</th>
                  <th>Contact Person</th>
                  <th>Email</th>
                  <th>Contact</th>
                  <th>Trip Charges</th>
                  <th>VAT%</th>
                  <th># of Trips</th>
                  <th>VAT Amount</th>
                  <th>Receivable Amount</th>
                  <th>Operations</th>
                </tr>
                </thead>
                <tbody id="tblbody">

                            {% comment %} <tr>...</tr> {% endcomment %}
                        {% comment %} <td id="td1">{{customer.first_name}} {{customer.last_name}}</td>
                        <td id="td2">{{customer.forignUser.location}}</td>
                        <td id="td3">{{customer.forignUser.contact}}</td>
                        <td id="td4"> {{customer.forignUser.tripCharges}}</td>
                        <td id="td5">{{customer.forignUser.Vat}}</td>
                        <td id="td6">-</td>
                        <td id="td7">-</td>
                        <td id="td8">-</td> {% endcomment %}
                        {% comment %} {% for customer in customers %}
                        <tr id='t{{customer.id}}'>
                        <td>{{customer.first_name}} {{customer.last_name}}</td>
                        <td>{{customer.forignUser.location}}</td>
                        <td>{{customer.forignUser.contact}}</td>
                        <td> {{customer.forignUser.tripCharges}}</td>
                        <td>{{customer.forignUser.Vat}}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td> <button id="edit{{customer.id}}" value={{customer.id}} class="ui teal button edit_btn" type="button" data-toggle="modal" data-target="#modal-default" >Edit</button> <button  id="del{{customer.id}}" value={{customer.id}} class="ui red button del_cust_button">Delete</button></td>
                        </tr>
                    {% endfor %} {% endcomment %}
                </tbody>
                <tfoot>
                <tr>
                  <th>Customer Name</th>
                  <th>Location</th>
                  <th>Record Number</th>
                  <th>Building Number</th>
                  <th>Managing By</th>
                  <th>Estate Name</th>
                  <th>Contact Person</th>
                  <th>Email</th>
                  <th>Contact</th>
                  <th>Trip Charges</th>
                  <th>VAT%</th>
                  <th># of Trips</th>
                  <th>VAT Amount</th>
                  <th>Receivable Amount</th>
                </tr>
                </tfoot>
              </table>


          </div>
          <!-- /.card-body -->
        </div>
        <!-- /.card -->
      </section>
      <!-- /.content -->
</div>

<script>

    function viewprofile(){
        $.ajax({
                type : "GET" ,
                url :  '/customerlistshow/',
               // data : {id:'{{id}}'},


                success: function(response){


                   // console.log(response.daata)
                  $("#customerTable tbody").empty()
                     response.customerProfile.forEach((item, index) => {
                       console.log(item)
                        $("#customerTable tbody").append(`<tr><td>${item.user.first_name} ${item.user.last_name}</td>
                        <td id="locid">${item.location}</td>
                        <td>${item.record_number}</td>
                        <td>${item.building_number}</td>
                        <td>${item.managing_by}</td>
                        <td>${item.estate_name}</td>
                        <td>${item.contact_person}</td>
                        <td>${item.email}</td>
                        <td>${item.contact}</td>
                        <td>${item.tripCharges}</td>
                        <td >${item.Vat}</td>
                        <td >${item.noOfTrips}</td>
                        <td >${item.vatAmount}</td>
                        <td >${item.ReceivableAmount}</td>
                        <td> <button id="edit${item.user.id}" value="${item.user.id}" onclick="editFunction(${item.user.id})"  class="ui teal button edit_btn" type="button" data-toggle="modal" data-target="#modal-default" >Edit</button> <button  id="del${item.user.id}" onclick="deleteFunction(${item.user.id})"  class="ui red button del_cust_button">Delete</button></td>
                    </tr>`)

                        /*$("#td1").append(item.user.first_name)
                        //$("#td").html(item.user.first_name)
                        $("#td2").append(item.location)
                        $("#td3").append(item.contact)
                        $("#td4").append(item.tripCharges)
                        $("#td5").append(item.Vat)  */
                      });
                }

              });
          }
     $(document).ready(function(){


           viewprofile();

           //=========================================================================

     });


  /*  $("#updateForm").submit(function(e){
        e.preventDefault();
        var formData = new FormData(this);
        console.log("check")
        var val = $("#edit_btn").val();
        console.log(formData)
        $.ajax({
            type : "POST" ,
            url :  '/updatecustomer/'+val.toString()+'/',
            contentType: false,
            processData: false,
            data : formData,
            //headers: {'X-CSRFToken': csrftoken},
           // headers: {"Authorization": localStorage.getItem('token')}

            success: function(response){
                alert("good")
            }
        });
    }); */


   //$(".edit_btn").click(function(){
       function editFunction(arg){
        console.log(arg)
        let val = arg

       // const csrftoken = Cookies.get('csrftoken');
       const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
       $("#postId").attr("value",val)
        $.ajax({
                type : "POST" ,
                url :  '/customerlistshow/',
                data : {id: val},
                headers: {'X-CSRFToken': csrftoken},
               // headers: {"Authorization": localStorage.getItem('token')}

                success: function(response){

                   //var customerobj =response.specificCustomer
                   let customerdata=response.customerdata
                   let managing_by=response.managing_by
                        $("#dropdown").empty()
                        $("#first_name").prop("value",customerdata.user.first_name)
                        $("#last_name").prop("value",customerdata.user.last_name)
                        $("#contact").prop("value",customerdata.contact)
                        $("#tripCharges").prop("value",customerdata.tripCharges)
                        $("#Vat").prop("value",customerdata.Vat)
                        $("#location").prop("value",customerdata.location)
                        $("#record_number").prop("value",customerdata.record_number)
                        $("#building_number").prop("value",customerdata.building_number)
                        $("#managing_by").prop("value",customerdata.managing_by)
                        $("#estate_name").prop("value",customerdata.estate_name)
                        $("#contact_person").prop("value",customerdata.contact_person)
                        $("#email").prop("value",customerdata.email)


                   $("#dropdown").html( `<option id="defaultOption" name="location" value='${customerdata.managing_by}' selected>${customerdata.managing_by}</option>`)
                   $("#dropdown").append(`<option id="dropdown1" name="location" value='Owner' >Owner</option>`)
                   $("#dropdown").append(`<option id="dropdown1" name="location" value='Real Estate' >Real Estate</option>`)
                   $("#dropdown").append(`<option id="dropdown1" name="location" value='Other' >Other</option>`)

                   /*
                   //drop down without the loacation of slected customer
                           managing_by.forEach((locationitem, index) => {
                                // alert(x.username)
                                if(location.id!=customerdata.location){
                                $("#dropdown").append(`<option id="dropdown1" name="location" value='${locationitem.id}' >${locationitem.locationName}</option>`)
                                }else{
                                    $("#dropdown").append( `<option id="defaultOption" name="location" value='${customerdata.location}' selected>${locationitem.locationName}</option>`)

                                }
                                });//end foreach   
                                  
                                  */

                                
                  /*for(location in response.locations){
                   $("#dropdown1").html(location)
                        }*/


                 //$("#t"+val).remove()








                }//end success
              });//ajax end


      //});
    }// view function end
    //});

    $("#updateForm").submit(function(e){
        e.preventDefault();
        $("#modal-default").modal('hide');
        $(".modal-backdrop").modal('hide');
        var formData = new FormData(this);


        //var delay=30;
        var g =  $("#postId").val()
       // var g=$(".edit_btn").val()

        $.ajax({
                    type : "POST" ,
                    url :  '/updatecustomer/'+g.toString()+'/',
                    contentType: false,
                    processData: false,
                    data : formData,
                    //headers: {'X-CSRFToken': csrftoken},
                // headers: {"Authorization": localStorage.getItem('token')}

                    success: function(response){

                        viewprofile()

                        /* setTimeout(function() {
                            window.location.replace("/customerlist/")
                        }, delay); */

                        //window.location.replace("/customerlist/")
                        if(response.updatecheck==true){
                                $(document).Toasts('create', {
                                class: 'bg-info',
                                title: 'Toast Title',
                                subtitle: 'Subtitle',
                                body: 'Updated Successfully!',
                                autohide: true
                                });

                        }//end if ststmenet




                    }//end success
            });//end ajax
});// end update form






    //$(".del_cust_button").click(function(){
        function deleteFunction(param){
        var val = param
        console.log(val)
        $.ajax({
                type : "GET" ,
                url :  '/deletecustomer/',
                data : {id: val},
               // headers: {"Authorization": localStorage.getItem('token')}

                success: function(response){
                   
                  if(response.allowed==true){
                     $(document).Toasts('create', {
                         class: 'bg-info',
                         title: 'Toast Title',
                         subtitle: 'Subtitle',
                         body: 'Sorry You are not Allowed | Admin Rights',
                         autohide: true
                         });
 
 
                  }
                  else if(response.confirm==true){
                     $(document).Toasts('create', {
                     class: 'bg-info',
                     title: 'Toast Title',
                     subtitle: 'Subtitle',
                     body: 'Deleted Successfully!',
                     autohide: true
                     });
                     //delay=1000
                     //$("#toastsContainerTopRight").toast("hide");
             }
                     
             viewprofile()
                  
                 }
              });


      //});
            }
   // });
    </script>


{% endblock content%}